<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>WebDAV 파일 탐색기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .file-item {
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
    }
    .file-item:hover {
      background-color: #f8f9fa;
    }
    .file-item.selected {
      background-color: #e9ecef;
    }
    .file-explorer {
      height: 70vh;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }
    .breadcrumb-item a {
      text-decoration: none;
    }
    .badge-pill {
      border-radius: 50rem;
    }
  </style>
</head>
<body>
<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>WebDAV 파일 탐색기</h2>
    <a href="/" class="btn btn-secondary">메인으로 돌아가기</a>
  </div>

  <div class="row">
    <!-- 클라우드 파일 탐색기 -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">클라우드 파일</h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="enableMultiSelect">
            <label class="form-check-label text-white" for="enableMultiSelect">다중 선택 모드</label>
          </div>
        </div>
        <div class="card-body">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb" id="cloudBreadcrumb">
              <li class="breadcrumb-item"><a href="#" onclick="navigateCloud('')">루트</a></li>
              <th:block th:if="${currentCloudPath != ''}">
                <li class="breadcrumb-item active" th:text="${currentCloudPath}"></li>
              </th:block>
            </ol>
          </nav>

          <div class="file-explorer">
            <div th:if="${cloudFiles.empty}" class="text-center p-4">
              <p>파일이 없습니다.</p>
            </div>
            <div th:unless="${cloudFiles.empty}">
              <div th:if="${currentCloudPath != ''}" class="file-item" onclick="navigateParentCloud()">
                <i class="bi bi-arrow-up-circle me-2"></i>상위 폴더로
              </div>
              <div th:each="file : ${cloudFiles}" class="file-item"
                   th:data-path="${file.filePath}"
                   th:data-name="${file.fileName}"
                   th:data-type="${file.directory} ? 'dir' : 'file'"
                   onclick="handleCloudFileClick(this)">
                <i th:class="${file.directory} ? 'bi bi-folder me-2' : 'bi bi-file-earmark me-2'"></i>
                <span th:text="${file.fileName}"></span>
                <span th:if="${!file.directory}" class="text-muted ms-2"
                      th:text="${#numbers.formatDecimal(file.fileSize / 1024, 0, 'COMMA', 2, 'POINT')} + ' MB'"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 선택된 다중 파일 표시 영역 -->
      <div id="selectedFilesContainer" class="card mt-3" style="display: none;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">선택된 파일 목록 <span id="selectedCount" class="badge bg-light text-dark badge-pill">0</span></h5>
        </div>
        <div class="card-body">
          <ul id="selectedFilesList" class="list-group">
          </ul>
          <button type="button" class="btn btn-sm btn-warning mt-2" onclick="clearSelection()">선택 초기화</button>
        </div>
      </div>
    </div>

    <!-- NAS 파일 탐색기 -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">서버 파일</h5>
        </div>
        <div class="card-body">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb" id="serverBreadcrumb">
              <li class="breadcrumb-item"><a href="#" onclick="navigateServer('')">루트</a></li>
              <th:block th:if="${currentServerPath != ''}">
                <li class="breadcrumb-item active" th:text="${currentServerPath}"></li>
              </th:block>
            </ol>
          </nav>

          <div class="file-explorer">
            <div th:if="${nasFiles.empty}" class="text-center p-4">
              <p>파일이 없습니다.</p>
            </div>
            <div th:unless="${nasFiles.empty}">
              <div th:if="${currentServerPath != ''}" class="file-item" onclick="navigateParentServer()">
                <i class="bi bi-arrow-up-circle me-2"></i>상위 폴더로
              </div>
              <div th:each="file : ${nasFiles}" class="file-item"
                   th:data-path="${file.filePath}"
                   th:data-type="${file.directory} ? 'dir' : 'file'"
                   onclick="handleServerFileClick(this)">
                <i th:class="${file.directory} ? 'bi bi-folder me-2' : 'bi bi-file-earmark me-2'"></i>
                <span th:text="${file.fileName}"></span>
                <span th:if="${!file.directory}" class="text-muted ms-2"
                      th:text="${#numbers.formatDecimal(file.fileSize / 1024, 0, 'COMMA', 2, 'POINT')} + ' MB'"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 전송 패널 -->
  <div class="card mt-3">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">파일 전송</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-5">
          <div class="mb-3">
            <label for="selectedCloudPath" class="form-label">선택한 클라우드 파일/폴더</label>
            <input type="text" class="form-control" id="selectedCloudPath" readonly>
          </div>
        </div>
        <div class="col-md-1 d-flex justify-content-center align-items-center">
          <i class="bi bi-arrow-right fs-3"></i>
        </div>
        <div class="col-md-5">
          <div class="mb-3">
            <label for="selectedServerPath" class="form-label">대상 서버 폴더</label>
            <input type="text" class="form-control" id="selectedServerPath" readonly>
          </div>
        </div>
        <div class="col-md-1 d-flex justify-content-center align-items-center">
          <button type="button" class="btn btn-primary" id="transferBtn" onclick="submitTransferForm()" disabled>전송</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 현재 경로 저장
  let currentCloudPath = "[[${currentCloudPath}]]";
  let currentServerPath = "[[${currentServerPath}]]";
  let selectedCloudFile = "";
  let selectedServerFolder = "";

  // 다중 선택 모드 변수
  let isMultiSelectMode = false;
  let selectedFiles = [];

  // 다중 선택 모드 전환
  document.getElementById('enableMultiSelect').addEventListener('change', function() {
    isMultiSelectMode = this.checked;
    document.getElementById('selectedFilesContainer').style.display = isMultiSelectMode ? 'block' : 'none';
    if (!isMultiSelectMode) {
      clearSelection();
    }
  });

  // 클라우드 파일 클릭 처리
  function handleCloudFileClick(element) {
    const path = element.getAttribute('data-path');
    const type = element.getAttribute('data-type');
    const name = element.getAttribute('data-name');

    if (isMultiSelectMode) {
      // 다중 선택 모드에서 처리
      toggleFileSelection(path, name, type === 'dir');

      // 선택된 요소 스타일링
      if (element.classList.contains('selected')) {
        element.classList.remove('selected');
      } else {
        element.classList.add('selected');
      }
    } else {
      // 일반 모드에서 처리
      if (type === 'dir') {
        navigateCloud(path);
      } else {
        selectCloudFile(path);
      }
    }
  }

  // 서버 파일 클릭 처리
  function handleServerFileClick(element) {
    const path = element.getAttribute('data-path');
    const type = element.getAttribute('data-type');

    if (type === 'dir') {
      navigateServer(path);
    } else {
      selectServerFile(path);
    }
  }

  // 파일 선택 토글
  function toggleFileSelection(path, name, isFolder) {
    const index = selectedFiles.findIndex(f => f.path === path);

    if (index >= 0) {
      // 이미 선택된 파일이면 선택 해제
      selectedFiles.splice(index, 1);
    } else {
      // 새로운 파일 선택
      selectedFiles.push({
        path: path,
        name: name,
        isFolder: isFolder
      });
    }

    // 선택 목록 UI 업데이트
    updateSelectedFilesList();
    updateTransferButton();
  }

  // 선택된 파일 목록 UI 업데이트
  function updateSelectedFilesList() {
    const listElement = document.getElementById('selectedFilesList');
    const countElement = document.getElementById('selectedCount');

    listElement.innerHTML = '';
    countElement.textContent = selectedFiles.length;

    selectedFiles.forEach(file => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      const icon = document.createElement('i');
      icon.className = file.isFolder ? 'bi bi-folder me-2' : 'bi bi-file-earmark me-2';

      const textSpan = document.createElement('span');
      textSpan.textContent = file.name;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn btn-sm btn-outline-danger';
      removeBtn.innerHTML = '<i class="bi bi-x"></i>';
      removeBtn.onclick = function(e) {
        e.stopPropagation();
        toggleFileSelection(file.path, file.name, file.isFolder);
      };

      li.appendChild(icon);
      li.appendChild(textSpan);
      li.appendChild(removeBtn);
      listElement.appendChild(li);
    });
  }

  // 선택 초기화
  function clearSelection() {
    selectedFiles = [];
    updateSelectedFilesList();

    // 선택된 스타일 제거
    document.querySelectorAll('.file-item.selected').forEach(el => {
      el.classList.remove('selected');
    });

    updateTransferButton();
  }

  // 클라우드 폴더 탐색
  function navigateCloud(path) {
    window.location.href = `/explorer?cloudPath=${encodeURIComponent(path)}&serverPath=${encodeURIComponent(currentServerPath)}`;
  }

  // 서버 폴더 탐색
  function navigateServer(path) {
    window.location.href = `/explorer?cloudPath=${encodeURIComponent(currentCloudPath)}&serverPath=${encodeURIComponent(path)}`;
  }

  // 클라우드 상위 폴더로 이동
  function navigateParentCloud() {
    const lastSlashIndex = currentCloudPath.lastIndexOf('/');
    const parentPath = lastSlashIndex > 0 ? currentCloudPath.substring(0, lastSlashIndex) : '';
    navigateCloud(parentPath);
  }

  // 서버 상위 폴더로 이동
  function navigateParentServer() {
    const lastSlashIndex = currentServerPath.lastIndexOf('/');
    const parentPath = lastSlashIndex > 0 ? currentServerPath.substring(0, lastSlashIndex) : '';
    navigateServer(parentPath);
  }

  // 클라우드 파일 선택
  function selectCloudFile(path) {
    selectedCloudFile = path;
    document.getElementById('selectedCloudPath').value = path;
    updateTransferButton();
  }

  // 서버 폴더 선택
  function selectServerFile(path) {
    selectedServerFolder = path;
    document.getElementById('selectedServerPath').value = path;
    updateTransferButton();
  }

  // 전송 버튼 활성화/비활성화
  function updateTransferButton() {
    const transferBtn = document.getElementById('transferBtn');

    if (isMultiSelectMode) {
      if (selectedFiles.length > 0 && (currentServerPath || selectedServerFolder)) {
        transferBtn.disabled = false;
      } else {
        transferBtn.disabled = true;
      }
    } else {
      if (selectedCloudFile && (currentServerPath || selectedServerFolder)) {
        transferBtn.disabled = false;
      } else {
        transferBtn.disabled = true;
      }
    }

    // 서버 폴더가 선택되지 않은 경우 현재 경로 사용
    if (!selectedServerFolder) {
      document.getElementById('selectedServerPath').value = currentServerPath;
    }
  }

  // 전송 폼 제출 처리 (다중 파일/폴더 지원) 부분만 수정
  function submitTransferForm() {
    if (isMultiSelectMode && selectedFiles.length > 0) {
      const serverPath = document.getElementById('selectedServerPath').value || currentServerPath;

      // 폴더 전송 여부 확인
      const folders = selectedFiles.filter(f => f.isFolder);

      if (folders.length > 0) {
        if (selectedFiles.length === 1) {
          // 단일 폴더 전송
          window.location.href = `/transfer/folder?cloudPath=${encodeURIComponent(folders[0].path)}&serverPath=${encodeURIComponent(serverPath)}`;
        } else {
          alert('폴더는 한 번에 하나씩만 전송할 수 있습니다.');
        }
      } else {
        // 다중 파일 전송
        const paths = selectedFiles.map(f => f.path).join(',');
        window.location.href = `/transfer/multiple?cloudPaths=${encodeURIComponent(paths)}&serverPath=${encodeURIComponent(serverPath)}`;
      }
    } else {
      // 단일 파일 전송 - 이 부분이 변경됨
      const cloudPath = document.getElementById('selectedCloudPath').value;
      const serverPath = document.getElementById('selectedServerPath').value || currentServerPath;
      window.location.href = `/transfer/single?cloudPath=${encodeURIComponent(cloudPath)}&serverPath=${encodeURIComponent(serverPath)}`;
    }
  }
</script>
</body>
</html>